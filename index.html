<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Beatboxer図鑑</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="layout">

    <!-- Header（検索/クリアを撤去） -->
    <header>
      <h1>Beatboxer図鑑</h1>
    </header>

    <!-- Sidebar（メニューだけ。レイアウトとスクロールの仕様は従来どおり） -->
    <aside id="sidebar" aria-label="メニュー">
      <nav class="menu">
        <button class="menu-item active" id="menuHome">Beatboxer一覧</button>
      </nav>
      <footer class="menu-note">今後ここに他メニューを追加予定</footer>
    </aside>

    <!-- Main -->
    <main>

      <!-- 一覧（ツールバー＋カードグリッド） -->
      <section id="listView">
        <!-- 一覧上部ツールバー -->
        <div id="toolbar" class="toolbar">
          <label class="ctl">
            <span>国籍</span>
            <select id="filterCountry"></select>
          </label>

          <label class="ctl">
            <span>年齢（最小）</span>
            <input id="ageMin" type="number" inputmode="numeric" placeholder="任意">
          </label>

          <label class="ctl">
            <span>年齢（最大）</span>
            <input id="ageMax" type="number" inputmode="numeric" placeholder="任意">
          </label>

          <label class="ctl">
            <span>並び替え</span>
            <select id="sortBy">
              <option value="name-asc">名前：A → Z</option>
              <option value="name-desc">名前：Z → A</option>
            </select>
          </label>
        </div>

        <div id="list" class="grid"></div>
      </section>

      <!-- 詳細 -->
      <section id="detailView" hidden>
        <nav class="detail-breadcrumb">
          <button id="backToList" class="btn">← 一覧へ戻る</button>
        </nav>
        <article id="profile" class="detail"></article>
      </section>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- 要素 ---------- */
  const $ = q => document.querySelector(q);
  const listEl = $("#list");
  const listView = $("#listView");
  const detailView = $("#detailView");
  const profileEl = $("#profile");

  // toolbar
  const countrySel = $("#filterCountry");
  const ageMinEl   = $("#ageMin");
  const ageMaxEl   = $("#ageMax");
  const sortSel    = $("#sortBy");

  /* ---------- 状態 ---------- */
  let LIST = [];                       // マニフェスト（一覧用）
  const PROFILE_CACHE = new Map();     // 詳細キャッシュ

  /* ---------- 便利関数 ---------- */
  const normalize = x => (x||"").toLowerCase();
  const slugify = s => (s||"").toLowerCase().replace(/[^a-z0-9\-]/g,'');
  const byNameAsc  = (a,b)=> a.name.localeCompare(b.name, 'en', {sensitivity:'base'});
  const byNameDesc = (a,b)=> b.name.localeCompare(a.name, 'en', {sensitivity:'base'});

  function thumbHTML(id, alt){
    const max = `https://i.ytimg.com/vi/${id}/maxresdefault.jpg`;
    const hq  = `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
    return `<img class="thumb" src="${max}" onerror="this.onerror=null;this.src='${hq}'" alt="${alt}">`;
  }
  function iframe(id){ return `<iframe src="https://www.youtube.com/embed/${id}" allow="autoplay; encrypted-media" allowfullscreen></iframe>` }

  /* ---------- マニフェスト ---------- */
  async function loadManifest(){
    const res = await fetch('profiles/index.json', {cache:'no-store'});
    const json = await res.json();
    LIST = json.list || [];
    buildToolbarOptions();
  }

  /* ---------- ツールバー初期化 ---------- */
  function buildToolbarOptions(){
    // 国籍
    const countries = ["All", ...Array.from(new Set(LIST.map(v=>v.country)))];
    countrySel.innerHTML = countries.map(c=>`<option value="${c}">${c}</option>`).join("");

    // 年齢のヒント（プレースホルダとして最小最大を入れるだけ）
    const ages = LIST.map(v=>v.age).filter(a=>Number.isFinite(a));
    if(ages.length){
      const min = Math.min(...ages), max = Math.max(...ages);
      ageMinEl.placeholder = String(min);
      ageMaxEl.placeholder = String(max);
    }
  }

  /* ---------- 詳細読み込み ---------- */
  async function loadProfile(slug){
    const key = slugify(slug);
    if (PROFILE_CACHE.has(key)) return PROFILE_CACHE.get(key);
    const res = await fetch(`profiles/${key}.json`, {cache:'no-store'});
    if(!res.ok) throw new Error('profile not found: '+key);
    const json = await res.json();
    PROFILE_CACHE.set(key, json);
    return json;
  }

  /* ---------- 一覧描画 ---------- */
  function cardHTML(p){
    const ageLine  = (p.age !== undefined && p.age !== null && p.age !== "")
      ? `<span class="stat"><b>年齢：</b>${p.age}</span>` : "";
    const bestLine = p.bestResult
      ? `<span class="stat"><b>最高戦績：</b>${p.bestResult}</span>` : "";

    return `
      <article class="card">
        <div onclick="playVideo('${p.ytId}', this)">${thumbHTML(p.ytId, p.name)}</div>
        <div class="pad">
          <div class="name">
            <a href="#p=${p.slug}" class="link-to-detail">${p.name}</a>（${p.country}）
          </div>
          <div class="stats">
            ${ageLine}
            ${bestLine}
          </div>
        </div>
      </article>`;
  }

  function currentFilters(){
    const country = countrySel.value || "All";
    const min = parseInt(ageMinEl.value,10);
    const max = parseInt(ageMaxEl.value,10);
    const sort = sortSel.value || "name-asc";
    return {country, min: Number.isFinite(min)?min:undefined, max: Number.isFinite(max)?max:undefined, sort};
  }

  function applySort(arr, key){
    if(key==="name-desc") return arr.sort(byNameDesc);
    return arr.sort(byNameAsc);
  }

  function renderList(){
    const {country, min, max, sort} = currentFilters();

    let out = LIST.filter(p=>{
      if(country!=="All" && p.country!==country) return false;
      if(Number.isFinite(min) && !(Number.isFinite(p.age) && p.age>=min)) return false;
      if(Number.isFinite(max) && !(Number.isFinite(p.age) && p.age<=max)) return false;
      return true;
    });

    applySort(out, sort);
    listEl.innerHTML = out.map(cardHTML).join("");
  }

  /* ---------- 詳細描画 ---------- */
  function detailHTML(p){
    const basics = (p.basics||[]).map(b=>`<div><span>${b.label}</span><strong>${b.value}</strong></div>`).join("");
    const strength = (p.strengths||[]).map(s=>`<span class="tag">${s}</span>`).join("");
    const videos = (p.videoIds||[]).map(v=>`<div class="detail-video">${iframe(v)}</div>`).join("");
    const links = (p.links||[]).map(l=>`<a class="btn link-ghost" href="${l.url}" target="_blank" rel="noopener">${l.label} ↗</a>`).join("");
    return `
      <header class="detail-head">
        <div class="detail-title">
          <h2>${p.name}</h2>
          <div class="meta">${p.summary||""}</div>
        </div>
      </header>
      <section class="detail-section">
        <h3>基本情報</h3>
        <div class="detail-basics">${basics}</div>
      </section>
      <section class="detail-section">
        <h3>特徴</h3>
        <div class="tags">${strength}</div>
      </section>
      <section class="detail-section">
        <h3>代表動画</h3>
        <div class="detail-videos">${videos}</div>
      </section>
      <section class="detail-section">
        <h3>リンク</h3>
        <div class="detail-links">${links}</div>
      </section>
      <section class="detail-section">
        <h3>メモ</h3>
        <p class="meta">${p.notes||"未入力"}</p>
      </section>`;
  }

  async function showDetailBySlug(s){
    try{
      const p = await loadProfile(s);
      profileEl.innerHTML = detailHTML(p);
      listView.hidden = true; detailView.hidden = false;
    }catch(e){
      console.error(e); showList();
    }
  }
  function showList(){ detailView.hidden = true; listView.hidden = false; }

  /* ---------- ルーティング ---------- */
  function routeFromHash(){
    const m = location.hash.match(/p=([a-z0-9\-]+)/i);
    if(m){ showDetailBySlug(m[1]); } else { showList(); }
  }
  window.addEventListener('hashchange', routeFromHash);

  /* ---------- イベント ---------- */
  window.playVideo = (id, el)=>{
    el.outerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  };
  $("#backToList").addEventListener("click", ()=>{ history.pushState(null,"",location.pathname+location.search); routeFromHash(); });

  // ツールバーの変更で再描画
  [countrySel, ageMinEl, ageMaxEl, sortSel].forEach(el=>{
    el.addEventListener('input', renderList);
    el.addEventListener('change', renderList);
  });

  /* ---------- 初期化 ---------- */
  (async ()=>{
    await loadManifest();
    renderList();
    routeFromHash();
  })();

});
</script>
</body>
</html>
